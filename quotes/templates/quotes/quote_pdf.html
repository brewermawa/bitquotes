{% load static humanize %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotización {{ quote.number }}</title>
    <link rel="stylesheet" href="{% static 'css/quote_pdf.css' %}">
</head>
<body>

    <!-- ENCABEZADO EMPRESA -->
    <div class="header">
        <table class="header-table header-table-v2">
            <tr>
                <!-- Texto a la izquierda -->
                <td class="header-left">
                    <div class="company-name">
                        Big Impression Tecnología, SA de CV
                    </div>
                    <div class="company-info">
                        Vasconcelos 101 Local 1<br>
                        Bosques del Valle, San Pedro GG C.P. 66250<br>
                        <span class="company-web">http://www.bi-tecnologia.com</span><br>
                        <span class="company-distributor">DISTRIBUIDOR AUTORIZADO HP DESIGNJET</span>
                    </div>
                </td>

                <!-- Logo BI a la derecha -->
                <td class="header-right">
                    <img src="{% static 'images/logo-bit.png' %}" class="logo-bi">
                </td>
            </tr>

            <tr>
                <td colspan="2" class="header-tagline">
                    Contamos con toda la línea de cartuchos HP originales, cabezales, papeles para impresión,
                    servicio de mantenimiento preventivo y correctivo, servicio de impresión.
                </td>
            </tr>
        </table>
    </div>

    <!-- BLOQUE CLIENTE Y FECHA -->
    <div class="client-date-row">
        <div class="client-block">
            <div class="client-name">
                {{ quote.customer.name }}
            </div>
            <div class="client-contact">
                Attn: {{ quote.contact.full_name }}<br>
                {% if quote.contact.phone %}Tel. {{ quote.contact.formatted_phone }}{% endif %}
                {% if quote.contact.phone and quote.contact.cel_phone %}<br>{% endif %}
                {% if quote.contact.cel_phone %}Cel. {{ quote.contact.formatted_cel_phone }}{% endif %}
            </div>
        </div>
        <div class="right-date">
            Monterrey, N.L. a {{ quote.created|date:"j \\d\\e F \\d\\e Y" }}
        </div>
    </div>

    <!-- SALUDO / INTRO -->
    <p class="greeting">
        <strong>Estimado {{ quote.contact.first_name }}:</strong>
        <br>
        Agradeciendo su preferencia por los productos y servicios que ofrecemos en BI Tecnología,
        a continuación le presento la cotización de los productos solicitados para su consideración:
    </p>

    {% for section in quote.quote_sections.all %}
    {% cycle 'qs-blue' 'qs-peach' as section_theme silent %}
        <div class="quote-section {{ section_theme }}">
            <table class="qs-table">
                <colgroup>
                    <col style="width:10%">
                    <col style="width:55%">
                    <col style="width:10%">
                    <col style="width:14%">
                    <col style="width:11%">
                </colgroup>

                <thead>
                    <tr class="qs-head-row">
                    <th colspan="2" class="qs-section-title">{{ section.name }}</th>
                    <th class="qs-col-h text-center">Cantidad</th>
                    <th class="qs-col-h text-right">Precio unitario</th>
                    <th class="qs-col-h text-right">Subtotal</th>
                    </tr>
                </thead>

                <tbody>
                    {% for line in section.section_lines.all %}
                        <tr class="qs-item-row">
                            <!-- Col 1: SKU / clave -->
                            <td class="qs-sku">
                                {% if line.product.sku %}{{ line.product.sku }}{% else %}-{% endif %}
                            </td>

                            <!-- Col 2: descripción (60%) -->
                            <td class="qs-desc">
                                <div class="qs-item-name">{{ line.product.name }}</div>

                                {% if line.product.description %}
                                    <div class="qs-item-detail">{{ line.product.description }}</div>
                                {% endif %}
                            </td>

                            <!-- Col 3: cantidad -->
                            <td class="qs-qty text-center">
                                {{ line.quantity|floatformat:0 }}
                            </td>

                            <!-- Col 4: precio unitario -->
                            <td class="qs-unit text-right">
                                {% if line.unit_price and line.unit_price > 0 %}
                                    ${{ line.unit_price|floatformat:2|intcomma }}
                                {% else %}
                                    Sin costo
                                {% endif %}
                            </td>

                            <!-- Col 5: subtotal -->
                            <td class="qs-subtotal text-right">
                                {% if line.gross_total and line.gross_total > 0 %}
                                    ${{ line.gross_total|floatformat:2|intcomma }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    <!-- Totales por sección -->
                    <tr class="qs-totals-spacer">
                        <td colspan="5"></td>
                    </tr>

                    <tr class="qs-totals-row">
                        <td colspan="4" class="qs-tot-label">Subtotal</td>
                        <td class="qs-tot-val">${{ section.get_subtotal|floatformat:2|intcomma }}</td>
                    </tr>

                    {% if section.get_discount and section.get_discount > 0 %}
                        <tr class="qs-totals-row">
                            <td colspan="4" class="qs-tot-label">Descuento</td>
                            <td class="qs-tot-val">-${{ section.get_discount|floatformat:2|intcomma }}</td>
                        </tr>

                        <tr class="qs-totals-row">
                            <td colspan="4" class="qs-tot-label">Subtotal después de descuento</td>
                            <td class="qs-tot-val">${{ section.net_subtotal|floatformat:2|intcomma }}</td>
                        </tr>
                    {% endif %}

                    <tr class="qs-totals-row">
                        <td colspan="4" class="qs-tot-label">IVA</td>
                        <td class="qs-tot-val">${{ section.tax|floatformat:2|intcomma }}</td>
                    </tr>

                    <tr class="qs-totals-row qs-totals-grand">
                        <td colspan="4" class="qs-tot-label">Total</td>
                        <td class="qs-tot-val">${{ section.total|floatformat:2|intcomma }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% endfor %}

    <!-- CONDICIONES COMERCIALES -->
    <div class="commercial-terms">
        <table class="commercial-table">
            <tr>
                <td class="ct-label">Vigencia de la cotización:</td>
                <td class="ct-value">
                    {{ quote.valid_until|default:15 }}
                </td>
            </tr>

            <tr>
                <td class="ct-label">Términos de pago:</td>
                <td class="ct-value">
                    {{ quote.get_payment_terms_display|default:"Transferencia / Depósito" }}
                </td>
            </tr>

            <tr>
                <td class="ct-label">Tiempo de entrega:</td>
                <td class="ct-value">
                    {% if quote.max_delivery_time %}
                        {{ quote.max_delivery_time }} días hábiles
                    {% else %}
                        Inmediato
                    {% endif %}

                </td>
            </tr>
            <tr>
                <td class="ct-label">Garantía:</td>
                <td class="ct-value">
                    {{ quote.warranty_terms|default:"Garantía directa del fabricante. No cubre daños por mal uso o variaciones eléctricas." }}
                </td>
            </tr>

            <tr>
                <td class="ct-label">Precios:</td>
                <td class="ct-value">
                    {{ quote.pricing_terms|default:"Precios en MXN. +16% IVA. Sujetos a cambio sin previo aviso. " }}
                </td>
            </tr>
        </table>
    </div>

    <!-- FIRMA / VENDEDOR + LOGO HP -->
    <div class="sig-row">

        <!-- Línea de firma (100%) -->
        <div class="sig-line"></div>

        <!-- Contenido: firma (izq) + logo (der) -->
        <div class="sig-content">

            <div class="sig-left">
                <div class="sig-company">Big Impression Tecnología</div>

                <div class="sig-name">{{ quote.user.get_full_name }}</div>
                <div class="sig-role">{{ quote.user.profile.position }}</div>

                <div class="sig-contact">
                    Tel. {{ quote.user.profile.formatted_phone }} &nbsp;|&nbsp;
                    Cel. {{ quote.user.profile.formatted_cel_phone }}
                </div>

                <div class="sig-email">{{ quote.user.email }}</div>

                <div class="sig-web">www.bi-tecnologia.com</div>
            </div>

            <div class="sig-right">
                <img src="{% static 'images/logo-hp.png' %}" class="sig-hp-logo">
            </div>

        </div>
    </div>
</body>
</html>
