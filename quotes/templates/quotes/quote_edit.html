{% extends 'base.html' %}

{% block content_header %}
    <div class="d-flex align-items-end justify-content-between mt-3 mb-2">
        <div>
            <h1 class="h4 mb-1 d-flex align-items-center gap-2">
                <i class="bi bi-receipt"></i>
                <span>Detalle de cotización</span>
            </h1>

            
            <div class="mb-2">
                <span class="badge bg-light text-dark border px-3 py-2 fs-6">
                    {{ quote.quote_id }}
                </span>
            </div>

            <small class="text-muted d-block">
                Cliente: <strong>{{ quote.customer.name }}</strong>
                {% if quote.contact %}
                — Contacto: <strong>{{ quote.contact.full_name }}</strong>
                {% endif %}
            </small>

            {% if quote.user %}
            <small class="text-muted d-block">
                Asignado a:
                <strong>{{ quote.user.get_full_name|default:quote.user.username }}</strong>
            </small>
            {% endif %}

            <small class="text-muted d-block">
                Términos de pago:
                <strong>{{ quote.get_payment_terms_display }}</strong>
            </small>
        </div>

        <div class="text-end">
            <a href="{% url 'quotes:quote_list' %}"
                class="btn btn-outline-secondary d-flex align-items-center gap-2">
                <i class="bi bi-arrow-left"></i>
                <span>Regresar</span>
            </a>
        </div>
    </div>

    <hr class="mt-3 mb-4">
{% endblock content_header %}

{% block content %}
    {% if quote_line_form.non_field_errors %}
        <div class="alert alert-danger">{{ line_form.non_field_errors }}</div>
    {% endif %}
    <form method="post" class="card shadow-sm p-4">
        {% csrf_token %}

        <!-- SECCIÓN: Modificar términos de pago -->
        <div class="d-flex align-items-center justify-content-between mb-3" style="gap: 1rem;">
            <div class="small text-muted">
                Modificar términos de pago:
            </div>
            <div class="d-flex align-items-center gap-2">
                {{ payment_terms_form.payment_terms }}
                {% if payment_terms_form.payment_terms.errors %}
                    <div class="invalid-feedback d-block">
                        {{ payment_terms_form.payment_terms.errors.0 }}
                    </div>
                {% endif %}
            </div>
        </div>
        <hr class="my-4" style="opacity: .15;">
        <!-- Líneas de cotización existentes -->
         <h2 class="h5 mb-3 d-flex align-items-center gap-2">
            <i class="bi bi-list-ol"></i>
            <span>Líneas de cotización</span>
        </h2>

        <div class="table-responsive mb-4">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr class="text-muted small">
                        <th style="width: 40px;">#</th>
                        <th style="width: 140px;">Núm. de parte</th>
                        <th>Nombre del producto</th>
                        <th style="width: 100px;" class="text-end">Cantidad</th>
                        <th style="width: 140px;" class="text-end">Precio unitario</th>
                        <th style="width: 120px;" class="text-end">Descuento</th>
                        <th style="width: 140px;" class="text-end">Subtotal</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>

                <tbody id="quote-lines-body" class="small">
                    <tr>
                        <td>1</td>
                        <td>T650-24</td>
                        <td>HP DesignJet T650 24-in</td>
                        <td class="text-end">
                            <input type="number"
                                   class="form-control form-control-sm text-end js-qty-input"
                                   name="qty_line_1"
                                   value="1"
                                   min="1"
                                   step="1"
                                   style="width: 80px; margin-left: auto;">
                        </td>
                        <td class="text-end js-unit-price" data-unit-price="39990.00">$ 39,990.00</td>
                        <td class="text-end">
                            <select class="form-select form-select-sm text-end js-discount-select"
                                    name="discount_line_1"
                                    style="width: 90px; margin-left: auto;">
                                <option value="0" selected>0%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                            </select>
                        </td>
                        <td class="text-end js-subtotal">$ 39,990.00</td>
                        <td class="text-end">
                            <button type="button"
                                    class="btn btn-sm btn-link text-danger p-0 js-delete-line"
                                    title="Eliminar línea">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>

                    <tr>
                        <td>2</td>
                        <td>KOD-PS50</td>
                        <td>Kodak Alaris S2080w Scanner</td>
                        <td class="text-end">
                            <input type="number"
                                   class="form-control form-control-sm text-end js-qty-input"
                                   name="qty_line_2"
                                   value="2"
                                   min="1"
                                   step="1"
                                   style="width: 80px; margin-left: auto;">
                        </td>
                        <td class="text-end js-unit-price" data-unit-price="15500.00">$ 15,500.00</td>
                        <td class="text-end">
                            <select class="form-select form-select-sm text-end js-discount-select"
                                    name="discount_line_1"
                                    style="width: 90px; margin-left: auto;">
                                <option value="0" selected>0%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                            </select>
                        </td>
                        <td class="text-end js-subtotal">$ 27,900.00</td>
                        <td class="text-end">
                            <button type="button"
                                    class="btn btn-sm btn-link text-danger p-0 js-delete-line"
                                    title="Eliminar línea">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>

                    <tr>
                        <td>3</td>
                        <td>INK-914XL</td>
                        <td>Tinta HP 914XL Photo Black</td>
                        <td class="text-end">
                            <input type="number"
                                   class="form-control form-control-sm text-end js-qty-input"
                                   name="qty_line_3"
                                   value="4"
                                   min="1"
                                   step="1"
                                style="width: 80px; margin-left: auto;">
                        </td>
                        <td class="text-end js-unit-price" data-unit-price="890.00">$ 890.00</td>
                        <td class="text-end">
                            <select class="form-select form-select-sm text-end js-discount-select"
                                    name="discount_line_1"
                                    style="width: 90px; margin-left: auto;">
                                <option value="0" selected>0%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                            </select>
                        </td>
                        <td class="text-end js-subtotal">$ 3,560.00</td>
                        <td class="text-end">
                            <button type="button"
                                    class="btn btn-sm btn-link text-danger p-0 js-delete-line"
                                    title="Eliminar línea">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>


                    <!-- Si no hay líneas, mostrar este bloque -->
                    <!--
                    <tr>
                        <td colspan="7" class="text-muted text-center py-3">
                        Aún no hay productos en esta cotización.
                        </td>
                    </tr>
                    -->

                </tbody>
            </table>
        </div>

        <!-- SECCIÓN: Agregar nueva línea -->
        <h2 class="h6 mb-3 d-flex align-items-center gap-2">
            <i class="bi bi-plus-circle"></i>
            <span>Agregar nueva línea</span>
        </h2>

        <!-- Buscar / seleccionar producto -->
        <div class="mb-3">
            <label class="form-label fw-semibold small">Buscar producto</label>
            <input type="search"
                   class="form-control form-control-sm"
                   placeholder="Escribe nombre o número de parte…"
                   autocomplete="off"
                   id="product-search"
                   name="product_search">
                <!--
                  Aquí luego puedes conectar HTMX, por ejemplo:
                  hx-get=""
                  hx-trigger="keyup changed delay:300ms"
                  hx-target="#product-search-results"
                  hx-indicator="#product-search-loading"
                -->
            <div id="product-search-loading" class="htmx-indicator small text-muted mt-1">
                <i class="bi bi-arrow-repeat"></i> Buscando…
            </div>
        </div>

        <!-- Resultados de búsqueda de producto -->
        <div id="product-search-results" class="list-group mb-3">
            <!-- Ejemplos dummy mientras conectamos HTMX -->
            <button type="button"
                    class="list-group-item list-group-item-action small js-product-result"
                    data-part-number="T650-24"
                    data-product-name="HP DesignJet T650 24-in"
                    data-unit-price="39990.00">
                HP DesignJet T650 24" — T650-24 — $39,990.00
            </button>

            <button type="button"
                    class="list-group-item list-group-item-action small js-product-result"
                    data-part-number="T850-36"
                    data-product-name="HP DesignJet T850 36-in"
                    data-unit-price="64500.00">
                HP DesignJet T850 36" — T850-36 — $64,500.00
            </button>
        </div>

        

    </form>
{% endblock content %}

{% block extra_js %}
<script>
  // Formatear en MXN
  const mxnFormatter = new Intl.NumberFormat("es-MX", {
    style: "currency",
    currency: "MXN",
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });

  function recalcRowSubtotal(row) {
    const qtyInput = row.querySelector(".js-qty-input");
    const unitPriceCell = row.querySelector(".js-unit-price");
    const discountSelect = row.querySelector(".js-discount-select");
    const subtotalCell = row.querySelector(".js-subtotal");

    if (!qtyInput || !unitPriceCell || !discountSelect || !subtotalCell) return;

    const qty = parseFloat(qtyInput.value) || 0;
    const unitPrice = parseFloat(unitPriceCell.dataset.unitPrice || "0") || 0;
    const discount = parseFloat(discountSelect.value || "0") || 0;

    let subtotal = qty * unitPrice;
    if (discount > 0) {
      subtotal = subtotal * (1 - discount / 100);
    }

    subtotalCell.textContent = mxnFormatter.format(subtotal);
  }

  function getNextLineNumber() {
    const tbody = document.getElementById("quote-lines-body");
    if (!tbody) return 1;
    const rows = tbody.querySelectorAll("tr");
    return rows.length + 1;
  }

  function addProductAsLine(button) {
    const partNumber = button.getAttribute("data-part-number") || "";
    const productName = button.getAttribute("data-product-name") || "";
    const unitPrice = parseFloat(button.getAttribute("data-unit-price") || "0") || 0;

    const tbody = document.getElementById("quote-lines-body");
    if (!tbody) return;

    const lineNumber = getNextLineNumber();

    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${lineNumber}</td>
      <td>${partNumber}</td>
      <td>${productName}</td>

      <td class="text-end">
        <input type="number"
               class="form-control form-control-sm text-end js-qty-input"
               name="qty_line_${lineNumber}"
               value="1"
               min="1"
               step="1"
               style="width: 80px; margin-left: auto;">
      </td>

      <td class="text-end js-unit-price" data-unit-price="${unitPrice.toFixed(2)}">
        ${mxnFormatter.format(unitPrice)}
      </td>

      <td class="text-end">
        <select
          class="form-select form-select-sm text-end js-discount-select"
          name="discount_line_${lineNumber}"
          style="width: 90px; margin-left: auto;">
          <option value="0" selected>0%</option>
          <option value="5">5%</option>
          <option value="10">10%</option>
          <option value="15">15%</option>
          <option value="20">20%</option>
          <option value="25">25%</option>
          <option value="30">30%</option>
        </select>
      </td>

      <td class="text-end js-subtotal">
        ${mxnFormatter.format(unitPrice)}
      </td>

      <td class="text-end">
        <button type="button"
                class="btn btn-sm btn-link text-danger p-0 js-delete-line"
                title="Eliminar línea">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;

    tbody.appendChild(row);
  }

  document.addEventListener("DOMContentLoaded", function () {
    const tbody = document.getElementById("quote-lines-body");

    if (tbody) {
      // Cantidad dinámica
      tbody.addEventListener("input", function (event) {
        if (event.target.classList.contains("js-qty-input")) {
          const row = event.target.closest("tr");
          if (row) recalcRowSubtotal(row);
        }
      });

      // Descuento dinámico
      tbody.addEventListener("change", function (event) {
        if (event.target.classList.contains("js-discount-select")) {
          const row = event.target.closest("tr");
          if (row) recalcRowSubtotal(row);
        }
      });

      // Eliminar fila
      tbody.addEventListener("click", function (event) {
        const deleteBtn = event.target.closest(".js-delete-line");
        if (deleteBtn) {
          const row = deleteBtn.closest("tr");
          if (row) row.remove();
        }
      });

      // Recalcular las filas existentes al cargar
      tbody.querySelectorAll("tr").forEach((row) => {
        if (row.querySelector(".js-qty-input") && row.querySelector(".js-discount-select")) {
          recalcRowSubtotal(row);
        }
      });
    }

    // Agregar nueva línea desde resultados
    document.addEventListener("click", function (event) {
      const btn = event.target.closest(".js-product-result");
      if (btn) {
        addProductAsLine(btn);
      }
    });
  });
</script>
{% endblock extra_js %}